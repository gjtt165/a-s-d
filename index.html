<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MCP ç®¡ç†åå°åŸå‹</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #fff;
      --text: #1f2937;
      --muted: #6b7280;
      --pri: #1677ff;  /* é˜¿é‡Œè“è¿‘ä¼¼ */
      --pri-600: #0b5bd3;
      --ok: #16a34a;
      --warn: #f59e0b;
      --bad: #ef4444;
      --border: #e5e7eb;
      --chip: #eef4ff;
      --chip-text: #2450a6;
      --shadow: 0 1px 2px rgba(0,0,0,.08), 0 8px 24px rgba(0,0,0,.06);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color: var(--text); background: var(--bg); }
    a { color: var(--pri); text-decoration: none; }
    .layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
    .sidebar { background: #ffffff; border-right: 1px solid var(--border); padding: 16px 12px; position: sticky; top: 0; height: 100vh; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 18px; padding: 8px 10px; }
    .brand .logo { width: 28px; height: 28px; background: linear-gradient(135deg, #48b1fb, #06d6a0); border-radius: 8px; }
    .nav { margin-top: 10px; }
    .nav h4 { margin: 18px 10px 8px; font-size: 12px; letter-spacing: .04em; color: var(--muted); font-weight: 600; }
    .nav button { width: 100%; text-align: left; background: transparent; border: 0; border-radius: 10px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; color: var(--text); cursor: pointer; }
    .nav button:hover { background: #f3f6ff; }
    .nav button.active { background: var(--chip); color: var(--chip-text); font-weight: 600; }
    .nav .icon { width: 18px; height: 18px; opacity: .9; }

    .content { padding: 22px 28px; }
    .topbar { display: flex; gap: 12px; align-items: center; justify-content: space-between; }
    .search { display: flex; align-items: center; gap: 10px; background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 8px 12px; min-width: 380px; box-shadow: var(--shadow); }
    .search input { border: 0; outline: 0; width: 100%; font-size: 14px; }
    .actions { display: flex; gap: 10px; }
    .btn { border: 1px solid var(--border); background: #fff; color: var(--text); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .btn.primary { background: var(--pri); color: #fff; border-color: var(--pri); }
    .btn.ghost { background: transparent; }

    .page { margin-top: 18px; display: grid; gap: 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card h3 { margin: 0; padding: 16px 16px 0; font-size: 18px; }
    .card .sub { padding: 6px 16px 0; color: var(--muted); font-size: 13px; }
    .card .body { padding: 14px 16px 16px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { font-size: 14px; padding: 12px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: middle; }
    th { color: #475569; font-weight: 600; background: #fbfcff; position: sticky; top: 0; }

    .tag { padding: 4px 8px; border-radius: 999px; background: #f3f4f6; color: #334155; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; }
    .status { padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .s-ok { background: #ecfdf5; color: #065f46; }
    .s-warn { background: #fffbeb; color: #92400e; }
    .s-bad { background: #fef2f2; color: #991b1b; }
    .s-idle { background: #eef4ff; color: #1d4ed8; }

    .toolbar { display: flex; gap: 8px; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .filters { display: flex; gap: 8px; }
    select, input[type="datetime-local"], input[type="number"], input[type="text"], input[type="url"], textarea { border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; background: #fff; }
    textarea { min-height: 80px; resize: vertical; }

    /* modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(15,23,42,.42); z-index: 50; }
    .modal.show { display: flex; }
    .dialog { background: #fff; width: min(940px, 92vw); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); }
    .dialog header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid var(--border); }
    .dialog header h4 { margin: 0; font-size: 16px; }
    .dialog .content { padding: 16px; }
    .grid { display: grid; gap: 12px; }
    .g2 { grid-template-columns: 1fr 1fr; }
    .g3 { grid-template-columns: 1fr 1fr 1fr; }
    .field { display: grid; gap: 6px; }
    .field label { font-size: 13px; color: var(--muted); }
    .help { font-size: 12px; color: var(--muted); }
    .chip { padding: 4px 8px; font-size: 12px; background: var(--chip); color: var(--chip-text); border-radius: 999px; }
    .muted { color: var(--muted); }
    .right { text-align: right; }
    .empty { padding: 12px; color: var(--muted); font-size: 14px; }

    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { position: static; height: auto; }
      .search { min-width: 0; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand"><div class="logo"></div> MCP ç®¡ç†åå°</div>
      <div class="nav">
        <h4>ä¸šåŠ¡</h4>
        <button data-route="apps" class="active"><span class="icon">ğŸ§©</span> æ¨¡å‹åº”ç”¨ç®¡ç†</button>
        <button data-route="tags"><span class="icon">ğŸ·ï¸</span> æ¨¡å‹åº”ç”¨æ ‡ç­¾</button>
        <button data-route="biz-apps"><span class="icon">ğŸ¢</span> ä¼ä¸šåº”ç”¨ç®¡ç†</button>
        <button data-route="audit"><span class="icon">âœ…</span> ä¼ä¸šåº”ç”¨å®¡æ ¸</button>
        <button data-route="categories"><span class="icon">ğŸ—‚ï¸</span> ä¼ä¸šåº”ç”¨åˆ†ç±»</button>
        <h4>è¿ç»´</h4>
        <button data-route="monitor"><span class="icon">ğŸ“ˆ</span> æœåŠ¡ç›‘æ§ï¼ˆç¤ºæ„ï¼‰</button>
      </div>
      <div style="position:absolute; bottom:14px; left:14px; right:14px;">
        <div class="card">
          <div class="body" style="display:flex; align-items:center; gap:10px;">
            <div class="chip">æ¼”ç¤ºç¯å¢ƒ</div>
            <div class="muted" style="font-size:12px;">æ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨ LocalStorage</div>
          </div>
        </div>
      </div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div class="search"><span>ğŸ”</span><input id="globalSearch" placeholder="æœç´¢ åº”ç”¨/ä¼ä¸š/æ ‡ç­¾â€¦ (æŒ‰ Enter)" /></div>
        <div class="actions"><button class="btn ghost" id="exportBtn">å¯¼å‡ºæ•°æ®</button><button class="btn primary" id="importBtn">å¯¼å…¥æ•°æ®</button></div>
      </div>

      <section id="page" class="page"></section>
    </main>
  </div>

  <!-- å…±ç”¨å¼¹çª—ï¼šå‘å¸ƒæ¨¡å‹åº”ç”¨ -->
  <div class="modal" id="modal-app">
    <div class="dialog">
      <header>
        <h4>å‘å¸ƒæ¨¡å‹åº”ç”¨</h4>
        <button class="btn" data-close="#modal-app">å…³é—­</button>
      </header>
      <div class="content">
        <form id="form-app" class="grid g3">
          <div class="field"><label>åº”ç”¨åç§° *</label><input name="name" required placeholder="å¦‚ï¼šé€šä¹‰ä¸‡ç›¸-å›¾åƒç”Ÿæˆ"/></div>
          <div class="field"><label>é»˜è®¤å‰¯æœ¬æ•° *</label><input type="number" min="0" name="replicas" value="1" required/></div>
          <div class="field"><label>èŠ‚ç‚¹é…ç½® *</label><input name="node" placeholder="å¦‚ï¼š2CPU 8G / 1xA10 24G" required/></div>

          <div class="field"><label>å¯åŠ¨å‘½ä»¤ *</label><input name="cmd" placeholder="python serve.py --port=8000" required/></div>
          <div class="field"><label>æœåŠ¡åœ°å€ *</label><input type="url" name="svc" placeholder="https://svc.example.com" required/></div>
          <div class="field"><label>ç½‘å…³é…ç½®</label><input name="gateway" placeholder="/mcp/xxx, ç«¯å£ç­‰"/></div>

          <div class="field"><label>API è®¤è¯</label><input name="apikey" placeholder="å¯ä¸ºç©ºï¼Œæˆ–é€‰æ‹©å…è®¤è¯"/></div>
          <div class="field"><label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label><input name="tags" placeholder="CV,ç”Ÿæˆ,çƒ­é—¨"/></div>
          <div class="field"><label>æè¿°</label><input name="desc" placeholder="ä¸€å¥è¯ä»‹ç»æ­¤æ¨¡å‹æœåŠ¡"/></div>

          <div class="field"><label>è¿ç»­æœªä½¿ç”¨ N åˆ†é’Ÿåç¼©å®¹è‡³ 0 *</label><input type="number" min="0" name="idleToZero" value="15"/></div>
          <div class="field"><label>å¿«é€Ÿå”¤é†’ï¼ˆå†·å¯ä¼˜åŒ–ï¼‰</label>
            <select name="fastWarm">
              <option value="on">å¼€å¯</option>
              <option value="off">å…³é—­</option>
            </select>
          </div>
          <div class="field"><label>çŠ¶æ€</label>
            <select name="status">
              <option value="running">è¿è¡Œä¸­</option>
              <option value="pending">å¾…éƒ¨ç½²</option>
              <option value="idle">ç¼©å®¹åˆ°0</option>
            </select>
          </div>

          <div class="field g3" style="grid-column: 1 / -1;">
            <label>å¼¹æ€§ä¼¸ç¼©ç­–ç•¥</label>
            <div class="grid g3">
              <div class="field">
                <label>ä¾æ®</label>
                <select name="scaleBasis">
                  <option value="metrics">åŸºäºç›‘æ§æŒ‡æ ‡</option>
                  <option value="events">åŸºäºäº‹ä»¶æº</option>
                  <option value="cron">åŸºäº Cron è¡¨è¾¾å¼</option>
                </select>
              </div>
              <div class="field"><label>è‡ªå®šä¹‰æŒ‡æ ‡</label><input name="metric" placeholder="GPU ä½¿ç”¨ç‡ / QPS / å…¥ç«™æµé‡"/></div>
              <div class="field"><label>Cron è¡¨è¾¾å¼</label><input name="cron" placeholder="*/5 * * * *"/></div>
            </div>
            <div class="help">è¯´æ˜ï¼šå¯åœ¨å®¡æ ¸ç¯èŠ‚è¿›ä¸€æ­¥ç»†åŒ–ç­–ç•¥ï¼›æ­¤å¤„ä¸ºé»˜è®¤ç­–ç•¥ã€‚</div>
          </div>

          <div class="right" style="grid-column:1 / -1; margin-top:4px;">
            <button class="btn" type="button" data-close="#modal-app">å–æ¶ˆ</button>
            <button class="btn primary" type="submit">ä¿å­˜å¹¶å‘å¸ƒ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- å…±ç”¨å¼¹çª—ï¼šæ–°å¢æ ‡ç­¾ -->
  <div class="modal" id="modal-tag">
    <div class="dialog">
      <header>
        <h4>æ–°å¢æ ‡ç­¾</h4>
        <button class="btn" data-close="#modal-tag">å…³é—­</button>
      </header>
      <div class="content">
        <form id="form-tag" class="grid g2">
          <div class="field"><label>æ ‡ç­¾å *</label><input name="name" required placeholder="å¦‚ï¼šå›¾åƒç”Ÿæˆ"/></div>
          <div class="field"><label>æ˜¯å¦é¦–é¡µæ¨è</label>
            <select name="featured">
              <option value="false">å¦</option>
              <option value="true">æ˜¯</option>
            </select>
          </div>
          <div class="field" style="grid-column: 1 / -1"><label>æè¿°</label><input name="desc" placeholder="è¯¥æ ‡ç­¾çš„è¯´æ˜"/></div>
          <div class="right" style="grid-column: 1 / -1">
            <button class="btn" type="button" data-close="#modal-tag">å–æ¶ˆ</button>
            <button class="btn primary" type="submit">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- å…±ç”¨å¼¹çª—ï¼šä¼ä¸šåº”ç”¨å‘å¸ƒ/å®¡æ ¸ï¼ˆå¤ç”¨ï¼‰ -->
  <div class="modal" id="modal-biz">
    <div class="dialog">
      <header>
        <h4 id="biz-title">å‘å¸ƒä¼ä¸šåº”ç”¨</h4>
        <button class="btn" data-close="#modal-biz">å…³é—­</button>
      </header>
      <div class="content">
        <form id="form-biz" class="grid g3">
          <div class="field"><label>ä¼ä¸šåç§° *</label><input name="corp" required placeholder="å¦‚ï¼šä¸­ç§‘ç±»è„‘"/></div>
          <div class="field"><label>åº”ç”¨åç§° *</label><input name="name" required placeholder="å¦‚ï¼šä¼ä¸šæ™ºèƒ½é—®ç­”"/></div>
          <div class="field"><label>é•œåƒåŒ… *</label><input name="image" required placeholder="registry.example.com/qa:1.0.0"/></div>

          <div class="field"><label>èµ„æºç”³è¯·ï¼ˆCPU/GPU/å†…å­˜ï¼‰*</label><input name="res" required placeholder="2C/8G/1xA10"/></div>
          <div class="field"><label>æœ€å¤§è¿›ç¨‹æ•° *</label><input type="number" min="1" name="maxProc" value="4"/></div>
          <div class="field"><label>å‰¯æœ¬å¯ä¸º 0</label>
            <select name="zeroReplica">
              <option value="true">å…è®¸</option>
              <option value="false">ä¸å…è®¸</option>
            </select>
          </div>

          <div class="field"><label>å‘å¸ƒæ—¶é—´</label><input type="datetime-local" name="publishAt"/></div>
          <div class="field"><label>æ˜¯å¦è‡ªåŠ¨ä¸‹æ¶</label>
            <select name="autoOff">
              <option value="false">å¦</option>
              <option value="true">æ˜¯</option>
            </select>
          </div>
          <div class="field"><label>ä¸‹æ¶æ—¶é—´</label><input type="datetime-local" name="offAt"/></div>

          <div class="field" style="grid-column:1 / -1;">
            <label>å¼¹æ€§ä¼¸ç¼©ç­–ç•¥</label>
            <div class="grid g3">
              <div class="field">
                <label>ä¾æ®</label>
                <select name="scaleBasis">
                  <option value="metrics">ç›‘æ§æŒ‡æ ‡</option>
                  <option value="events">äº‹ä»¶æº</option>
                  <option value="cron">Cron è¡¨è¾¾å¼</option>
                </select>
              </div>
              <div class="field"><label>è‡ªå®šä¹‰æŒ‡æ ‡</label><input name="metric" placeholder="GPU ä½¿ç”¨ç‡ / QPS / å…¥ç«™æµé‡"/></div>
              <div class="field"><label>Cron è¡¨è¾¾å¼</label><input name="cron" placeholder="*/10 * * * *"/></div>
            </div>
            <div class="help">è¯´æ˜ï¼šæ”¯æŒåŸºäºäº‹ä»¶æºã€ç›‘æ§æŒ‡æ ‡ã€cron çš„å¼¹æ€§ä¼¸ç¼©ï¼›æå‡é›†ç¾¤åˆ©ç”¨ç‡ã€‚</div>
          </div>

          <div class="right" style="grid-column:1 / -1;">
            <button class="btn" type="button" data-close="#modal-biz">å–æ¶ˆ</button>
            <button class="btn primary" type="submit">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- å…±ç”¨å¼¹çª—ï¼šåˆ†ç±»é…ç½® -->
  <div class="modal" id="modal-cat">
    <div class="dialog">
      <header>
        <h4>ç¼–è¾‘åˆ†ç±»æ¨¡å—</h4>
        <button class="btn" data-close="#modal-cat">å…³é—­</button>
      </header>
      <div class="content">
        <form id="form-cat" class="grid g2">
          <div class="field"><label>åˆ†ç±»åç§° *</label><input name="name" required placeholder="å¦‚ï¼šæ–°å“æ¨è"/></div>
          <div class="field"><label>æ’åºæƒé‡</label><input type="number" name="weight" value="10"/></div>
          <div class="field" style="grid-column: 1 / -1"><label>å…³è”åº”ç”¨ï¼ˆç”¨é€—å·åˆ†éš”åº”ç”¨åï¼‰</label><textarea name="apps" placeholder="åº”ç”¨A, åº”ç”¨B, åº”ç”¨C"></textarea></div>
          <div class="field"><label>æ˜¯å¦åœ¨å‰ç«¯å±•ç¤º</label>
            <select name="visible"><option value="true">æ˜¯</option><option value="false">å¦</option></select>
          </div>
          <div class="field"><label>ç±»å‹</label>
            <select name="type">
              <option value="system">ç³»ç»Ÿé¢„è®¾</option>
              <option value="custom">è‡ªå®šä¹‰</option>
            </select>
          </div>
          <div class="right" style="grid-column: 1 / -1">
            <button class="btn" type="button" data-close="#modal-cat">å–æ¶ˆ</button>
            <button class="btn primary" type="submit">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // --- ç®€æ˜“çŠ¶æ€ç®¡ç†ä¸å­˜å‚¨ ---
    const DB_KEY = 'mcp-admin-demo-db-v1';
    const db = loadDB();

    function loadDB(){
      try {
        const raw = localStorage.getItem(DB_KEY);
        if(raw) return JSON.parse(raw);
      } catch(e) {}
      // åˆå§‹æ•°æ®
      const init = {
        apps: [
          { id: uid(), name:'é€šä¹‰ä¸‡ç›¸-å›¾åƒç”Ÿæˆ', cmd:'python serve.py --port=8000', replicas:1, node:'1xA10 24G', svc:'https://imggen.svc.local', gateway:'/mcp/img', apikey:'', tags:['CV','ç”Ÿæˆ'], desc:'æ–‡ç”Ÿå›¾æœåŠ¡', idleToZero:15, fastWarm:'on', status:'running', scaleBasis:'metrics', metric:'GPU ä½¿ç”¨ç‡>60%', cron:'' , createdAt: Date.now() - 1000*60*60 },
          { id: uid(), name:'é€šä¹‰åƒé—®-è¯­éŸ³åˆæˆ', cmd:'bash run.sh', replicas:2, node:'2CPU 8G', svc:'https://tts.svc.local', gateway:'/mcp/tts', apikey:'k-***', tags:['è¯­éŸ³','TTS'], desc:'è¯­éŸ³åˆæˆ', idleToZero:30, fastWarm:'off', status:'idle', scaleBasis:'cron', metric:'', cron:'*/10 * * * *' , createdAt: Date.now() - 1000*60*30 }
        ],
        tags: [
          { id: uid(), name:'å›¾åƒç”Ÿæˆ', featured:false, desc:'è®¡ç®—æœºè§†è§‰-ç”Ÿæˆæ–¹å‘', createdAt: Date.now()-1_000_000 },
          { id: uid(), name:'è¯­éŸ³', featured:true, desc:'ASR/TTS', createdAt: Date.now()-2_000_000 }
        ],
        bizApps: [
          { id: uid(), corp:'ä¸­ç§‘ç±»è„‘', name:'ä¼ä¸šæ™ºèƒ½é—®ç­”', image:'registry/acme-qa:1.0', res:'2C/8G', maxProc:4, zeroReplica:true, publishAt:'', autoOff:false, offAt:'', scaleBasis:'metrics', metric:'QPS>50', cron:'', status:'ä¸Šæ¶', createdAt: Date.now()-900000 },
          { id: uid(), corp:'æ˜Ÿäº‘ç§‘æŠ€', name:'åˆåŒè¦ç‚¹æŠ½å–', image:'registry/pie:2.1', res:'1C/4G', maxProc:2, zeroReplica:false, publishAt:'', autoOff:true, offAt:'', scaleBasis:'cron', metric:'', cron:'0 0 * * *', status:'ä¸‹æ¶', createdAt: Date.now()-600000 }
        ],
        audits: [
          { id: uid(), corp:'æµ·çº³æ•°æ®', name:'å®¢æœè´¨æ£€', image:'registry/qa:0.9', res:'2C/8G/1xA10', submitter:'wang', submittedAt: Date.now()-3600_000, status:'å¾…å®¡', config:{} }
        ],
        categories: [
          { id: uid(), name:'æ–°å“æ¨è', weight:10, apps:['é€šä¹‰ä¸‡ç›¸-å›¾åƒç”Ÿæˆ'], visible:true, type:'system', updatedAt: Date.now()-120000 },
          { id: uid(), name:'ç²¾å“æ¨è', weight:20, apps:['ä¼ä¸šæ™ºèƒ½é—®ç­”','åˆåŒè¦ç‚¹æŠ½å–'], visible:true, type:'system', updatedAt: Date.now()-220000 },
          { id: uid(), name:'ä¼˜æƒ ä¸“åŒº', weight:30, apps:[], visible:false, type:'system', updatedAt: Date.now()-320000 }
        ]
      };
      saveDB(init);
      return init;
    }

    function saveDB(data){ localStorage.setItem(DB_KEY, JSON.stringify(data)); }
    function uid(){ return Math.random().toString(36).slice(2,9); }

    // --- è·¯ç”± ---
    const page = document.getElementById('page');
    const navButtons = [...document.querySelectorAll('.nav button[data-route]')];
    navButtons.forEach(btn => btn.addEventListener('click', () => goto(btn.dataset.route)));
    window.addEventListener('hashchange', syncRoute);

    function goto(route){ location.hash = '#' + route; }
    function syncRoute(){
      const route = location.hash.replace('#','') || 'apps';
      navButtons.forEach(b => b.classList.toggle('active', b.dataset.route===route));
      render(route);
    }

    // --- æ¸²æŸ“ ---
    function render(route){
      if(route==='apps') return renderApps();
      if(route==='tags') return renderTags();
      if(route==='biz-apps') return renderBizApps();
      if(route==='audit') return renderAudit();
      if(route==='categories') return renderCategories();
      if(route==='monitor') return renderMonitor();
      page.innerHTML = '<div class="empty">æœªå®ç°çš„é¡µé¢</div>';
    }

    // å·¥å…·: é€šç”¨è¡¨æ ¼æ“ä½œåˆ—
    function opButtons(defs){
      return defs.map(d=>`<button class="btn" data-op="${d.op}" data-id="${d.id}">${d.text}</button>`).join(' ');
    }

    // --- é¡µé¢ï¼šæ¨¡å‹åº”ç”¨ç®¡ç† ---
    function renderApps(){
      const rows = db.apps.sort((a,b)=>b.createdAt-a.createdAt).map(a=>`
        <tr>
          <td>${a.name}</td>
          <td><code>${a.cmd}</code></td>
          <td>${a.replicas}</td>
          <td>${a.node}</td>
          <td><a href="${a.svc}" target="_blank">${a.svc}</a></td>
          <td>${statusPill(a.status)}</td>
          <td>${new Date(a.createdAt).toLocaleString()}</td>
          <td>
            ${opButtons([
              {op:'view-app', id:a.id, text:'æŸ¥çœ‹'},
              {op:'edit-app', id:a.id, text:'ç¼–è¾‘'},
              {op:'remove-app', id:a.id, text:'ä¸‹çº¿'}
            ])}
          </td>
        </tr>
      `).join('');

      page.innerHTML = `
        <div class="card">
          <h3>æ¨¡å‹åº”ç”¨ç®¡ç†</h3>
          <div class="sub">é€šè¿‡å¸‚åœºè¡¨å•å‘å¸ƒçš„æ¨¡å‹ä¼šåœ¨æ­¤å¤„ä»¥â€œåº”ç”¨æœåŠ¡â€å½¢å¼å‘ˆç°ï¼Œå¯æŸ¥çœ‹éƒ¨ç½²è¯¦æƒ…ã€API é…ç½®ã€ä¼¸ç¼©ç­–ç•¥ç­‰ã€‚</div>
          <div class="body">
            <div class="toolbar">
              <div class="filters">
                <select id="appsFilter">
                  <option value="">å…¨éƒ¨çŠ¶æ€</option>
                  <option value="running">è¿è¡Œä¸­</option>
                  <option value="pending">å¾…éƒ¨ç½²</option>
                  <option value="idle">ç¼©å®¹åˆ°0</option>
                </select>
              </div>
              <div>
                <button class="btn" id="btn-export-apps">å¯¼å‡º</button>
                <button class="btn primary" id="btn-new-app">+ å‘å¸ƒæ¨¡å‹åº”ç”¨</button>
              </div>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>åº”ç”¨åç§°</th><th>å¯åŠ¨å‘½ä»¤</th><th>å‰¯æœ¬æ•°</th><th>èŠ‚ç‚¹é…ç½®</th><th>æœåŠ¡åœ°å€</th><th>çŠ¶æ€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="appsTbody">${rows || '<tr><td colspan="8" class="empty">æš‚æ— æ•°æ®</td></tr>'}</tbody>
              </table>
            </div>
          </div>
        </div>`;

      // äº‹ä»¶ç»‘å®š
      document.getElementById('btn-new-app').onclick = ()=> openModal('#modal-app', fillForm('#form-app', null));
      document.getElementById('btn-export-apps').onclick = ()=> downloadJSON('apps.json', db.apps);
      document.getElementById('appsFilter').onchange = (e)=>{
        const val = e.target.value;
        const filtered = db.apps.filter(a=> !val || a.status===val);
        document.getElementById('appsTbody').innerHTML = filtered.map(a=>`
          <tr>
            <td>${a.name}</td>
            <td><code>${a.cmd}</code></td>
            <td>${a.replicas}</td>
            <td>${a.node}</td>
            <td><a href="${a.svc}" target="_blank">${a.svc}</a></td>
            <td>${statusPill(a.status)}</td>
            <td>${new Date(a.createdAt).toLocaleString()}</td>
            <td>${opButtons([{op:'view-app', id:a.id, text:'æŸ¥çœ‹'},{op:'edit-app', id:a.id, text:'ç¼–è¾‘'},{op:'remove-app', id:a.id, text:'ä¸‹çº¿'}])}</td>
          </tr>`).join('');
        bindRowOps('appsTbody');
      };
      bindRowOps('appsTbody');
    }

    function statusPill(s){
      const map = { running:'s-ok', pending:'s-warn', idle:'s-idle', error:'s-bad' };
      const text = { running:'è¿è¡Œä¸­', pending:'å¾…éƒ¨ç½²', idle:'ç¼©å®¹åˆ°0', error:'å¼‚å¸¸' };
      return `<span class="status ${map[s]||'s-warn'}">${text[s]||s}</span>`;
    }

    function bindRowOps(tbodyId){
      document.getElementById(tbodyId).querySelectorAll('button[data-op]').forEach(btn => {
        btn.addEventListener('click', () => {
          const {op, id} = btn.dataset;
          if(op==='remove-app'){ db.apps = db.apps.filter(x=>x.id!==id); saveDB(db); renderApps(); return; }
          if(op==='edit-app'){ const app = db.apps.find(x=>x.id===id); openModal('#modal-app', fillForm('#form-app', app)); return; }
          if(op==='view-app'){ const app = db.apps.find(x=>x.id===id); alert('API ç½‘å…³: '+app.gateway+'\nè®¤è¯: '+(app.apikey||'æ— ')); return; }
          if(op==='remove-tag'){ db.tags = db.tags.filter(x=>x.id!==id); saveDB(db); renderTags(); return; }
          if(op==='edit-tag'){ const t = db.tags.find(x=>x.id===id); openModal('#modal-tag', fillForm('#form-tag', t)); return; }
          if(op==='remove-biz'){ db.bizApps = db.bizApps.filter(x=>x.id!==id); saveDB(db); renderBizApps(); return; }
          if(op==='edit-biz'){ const it = db.bizApps.find(x=>x.id===id); openModal('#modal-biz', fillForm('#form-biz', it)); return; }
          if(op==='approve'){ const a = db.audits.find(x=>x.id===id); a.status='é€šè¿‡'; saveDB(db); renderAudit(); return; }
          if(op==='reject'){ const a = db.audits.find(x=>x.id===id); a.status='æ‹’ç»'; saveDB(db); renderAudit(); return; }
          if(op==='config'){ const a = db.audits.find(x=>x.id===id); openModal('#modal-biz', fillForm('#form-biz', { corp:a.corp, name:a.name, image:a.image, res:a.res, maxProc:4, zeroReplica:true, publishAt:'', autoOff:false, offAt:'', scaleBasis:'metrics', metric:'', cron:'' })); return; }
          if(op==='remove-cat'){ db.categories = db.categories.filter(x=>x.id!==id); saveDB(db); renderCategories(); return; }
          if(op==='edit-cat'){ const c = db.categories.find(x=>x.id===id); openModal('#modal-cat', fillForm('#form-cat', c)); document.getElementById('form-cat').dataset.editId = c.id; return; }
        });
      });
    }

    // --- é¡µé¢ï¼šæ ‡ç­¾ ---
    function renderTags(){
      const rows = db.tags.map(t=>`
        <tr>
          <td>${t.name}</td>
          <td>${t.featured?'æ˜¯':'å¦'}</td>
          <td>${t.desc||''}</td>
          <td>${new Date(t.createdAt).toLocaleString()}</td>
          <td>${opButtons([{op:'edit-tag', id:t.id, text:'ç¼–è¾‘'},{op:'remove-tag', id:t.id, text:'åˆ é™¤'}])}</td>
        </tr>`).join('');
      page.innerHTML = `
        <div class="card">
          <h3>æ¨¡å‹åº”ç”¨æ ‡ç­¾ç®¡ç†</h3>
          <div class="sub">ç»´æŠ¤æ ‡ç­¾å¹¶ä¸åº”ç”¨å…³è”ï¼Œæ”¯æŒç”¨æˆ·åœ¨å‰å°æŒ‰æ ‡ç­¾å¿«é€Ÿç­›é€‰ã€‚</div>
          <div class="body">
            <div class="toolbar"><div></div><button class="btn primary" id="btn-new-tag">+ æ–°å¢æ ‡ç­¾</button></div>
            <table>
              <thead><tr><th>æ ‡ç­¾å</th><th>é¦–é¡µæ¨è</th><th>æè¿°</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
              <tbody id="tagsTbody">${rows || '<tr><td colspan="5" class="empty">æš‚æ— æ ‡ç­¾</td></tr>'}</tbody>
            </table>
          </div>
        </div>`;
      document.getElementById('btn-new-tag').onclick = ()=> openModal('#modal-tag', fillForm('#form-tag', null));
      bindRowOps('tagsTbody');
    }

    // --- é¡µé¢ï¼šä¼ä¸šåº”ç”¨ç®¡ç† ---
    function renderBizApps(){
      const rows = db.bizApps.map(b=>`
        <tr>
          <td>${b.name}</td>
          <td>${b.corp}</td>
          <td>${b.status}</td>
          <td>${b.publishAt ? new Date(b.publishAt).toLocaleString() : '-'}</td>
          <td>${b.offAt ? new Date(b.offAt).toLocaleString() : '-'}</td>
          <td>${opButtons([{op:'edit-biz', id:b.id, text:'ç¼–è¾‘'},{op:'remove-biz', id:b.id, text:'åˆ é™¤'}])}</td>
        </tr>`).join('');
      page.innerHTML = `
        <div class="card">
          <h3>ä¼ä¸šåº”ç”¨ç®¡ç†</h3>
          <div class="sub">æ”¯æŒä¼ä¸šåº”ç”¨çš„å‘å¸ƒä¸ä¸‹æ¶ï¼Œå¯è®¾ç½®å‘å¸ƒæ—¶é—´ä¸å®šæ—¶ä¸‹æ¶ã€‚</div>
          <div class="body">
            <div class="toolbar"><div></div><button class="btn primary" id="btn-new-biz">+ å‘å¸ƒä¼ä¸šåº”ç”¨</button></div>
            <table>
              <thead><tr><th>åº”ç”¨å</th><th>ä¼ä¸š</th><th>çŠ¶æ€</th><th>å‘å¸ƒæ—¶é—´</th><th>ä¸‹æ¶æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
              <tbody id="bizTbody">${rows || '<tr><td colspan="6" class="empty">æš‚æ— ä¼ä¸šåº”ç”¨</td></tr>'}</tbody>
            </table>
          </div>
        </div>`;
      document.getElementById('btn-new-biz').onclick = ()=> openModal('#modal-biz', fillForm('#form-biz', null));
      bindRowOps('bizTbody');
    }

    // --- é¡µé¢ï¼šä¼ä¸šåº”ç”¨å®¡æ ¸ ---
    function renderAudit(){
      const rows = db.audits.map(a=>`
        <tr>
          <td>${a.corp}</td>
          <td>${a.name}</td>
          <td><code>${a.image}</code></td>
          <td>${a.res}</td>
          <td>${new Date(a.submittedAt).toLocaleString()}</td>
          <td>${a.status}</td>
          <td>
            ${opButtons([
              {op:'config', id:a.id, text:'é…ç½®ç­–ç•¥'},
              {op:'approve', id:a.id, text:'é€šè¿‡'},
              {op:'reject', id:a.id, text:'æ‹’ç»'}
            ])}
          </td>
        </tr>`).join('');
      page.innerHTML = `
        <div class="card">
          <h3>ä¼ä¸šåº”ç”¨å®¡æ ¸</h3>
          <div class="sub">åŸºäºç”³è¯·çš„èµ„æºå ç”¨ä¸é•œåƒä¿¡æ¯ï¼Œé…ç½®è°ƒç”¨ç­–ç•¥ã€æœ€å¤§è¿›ç¨‹æ•°ã€å‰¯æœ¬ä¸º0ç­–ç•¥ä»¥åŠå¼¹æ€§ä¼¸ç¼©ä¾æ®ã€‚</div>
          <div class="body">
            <table>
              <thead><tr><th>ä¼ä¸š</th><th>åº”ç”¨å</th><th>é•œåƒåŒ…</th><th>èµ„æºç”³è¯·</th><th>æäº¤æ—¶é—´</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
              <tbody id="auditTbody">${rows || '<tr><td colspan="7" class="empty">æš‚æ— å¾…å®¡è®°å½•</td></tr>'}</tbody>
            </table>
          </div>
        </div>`;
      bindRowOps('auditTbody');
    }

    // --- é¡µé¢ï¼šåˆ†ç±»ç®¡ç† ---
    function renderCategories(){
      const rows = db.categories.sort((a,b)=>a.weight-b.weight).map(c=>`
        <tr>
          <td>${c.name}</td>
          <td>${c.type==='system'?'ç³»ç»Ÿé¢„è®¾':'è‡ªå®šä¹‰'}</td>
          <td>${c.visible?'æ˜¾ç¤º':'éšè—'}</td>
          <td>${c.weight}</td>
          <td>${(c.apps||[]).join(', ')||'-'}</td>
          <td>${new Date(c.updatedAt).toLocaleString()}</td>
          <td>${opButtons([{op:'edit-cat', id:c.id, text:'ç¼–è¾‘'},{op:'remove-cat', id:c.id, text:'åˆ é™¤'}])}</td>
        </tr>`).join('');
      page.innerHTML = `
        <div class="card">
          <h3>ä¼ä¸šåº”ç”¨åˆ†ç±»ç®¡ç†</h3>
          <div class="sub">ç»´æŠ¤æ–°å“æ¨èã€ç²¾å“æ¨èã€ä¼˜æƒ ä¸“åŒºç­‰æ¨¡å—ã€‚</div>
          <div class="body">
            <div class="toolbar"><div></div><button class="btn primary" id="btn-new-cat">+ æ–°å¢åˆ†ç±»</button></div>
            <table>
              <thead><tr><th>åˆ†ç±»åç§°</th><th>ç±»å‹</th><th>å‰ç«¯æ˜¾ç¤º</th><th>æƒé‡</th><th>å…³è”åº”ç”¨</th><th>æ›´æ–°æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
              <tbody id="catTbody">${rows || '<tr><td colspan="7" class="empty">æš‚æ— åˆ†ç±»</td></tr>'}</tbody>
            </table>
          </div>
        </div>`;
      document.getElementById('btn-new-cat').onclick = ()=> { document.getElementById('form-cat').dataset.editId = ''; openModal('#modal-cat', fillForm('#form-cat', null)); };
      bindRowOps('catTbody');
    }

    // --- é¡µé¢ï¼šç›‘æ§ç¤ºæ„ ---
    function renderMonitor(){
      const cards = db.apps.map(a=>`
        <div class="card"><div class="body">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <div style="font-weight:700">${a.name}</div>
              <div class="muted" style="font-size:12px">å‰¯æœ¬ï¼š${a.replicas} ï½œ èŠ‚ç‚¹ï¼š${a.node} ï½œ çŠ¶æ€ï¼š${a.status}</div>
            </div>
            <span class="chip">${a.metric || 'QPS, GPU, å…¥ç«™æµé‡'}</span>
          </div>
          <div style="height:8px"></div>
          <div style="height:10px;background:linear-gradient(90deg, #c7d2fe, #93c5fd); border-radius:999px"></div>
        </div></div>
      `).join('');
      page.innerHTML = `<div class="grid g2">${cards}</div>`;
    }

    // --- è¡¨å•æäº¤å¤„ç† ---
    document.getElementById('form-app').addEventListener('submit', (e)=>{
      e.preventDefault();
      const f = new FormData(e.target); const d = Object.fromEntries(f.entries());
      d.replicas = +d.replicas; d.idleToZero = +d.idleToZero; d.tags = (d.tags||'').split(',').map(s=>s.trim()).filter(Boolean);
      if(e.target.dataset.editId){
        const i = db.apps.findIndex(x=>x.id===e.target.dataset.editId); d.id = db.apps[i].id; d.createdAt = db.apps[i].createdAt; db.apps[i] = d;
      } else { d.id = uid(); d.createdAt = Date.now(); db.apps.unshift(d); }
      saveDB(db); closeModal('#modal-app'); renderApps(); e.target.reset(); e.target.dataset.editId='';
    });

    document.getElementById('form-tag').addEventListener('submit', (e)=>{
      e.preventDefault(); const f = new FormData(e.target); const d = Object.fromEntries(f.entries()); d.featured = d.featured==='true';
      if(e.target.dataset.editId){ const i = db.tags.findIndex(x=>x.id===e.target.dataset.editId); d.id = db.tags[i].id; d.createdAt=db.tags[i].createdAt; db.tags[i]=d; }
      else { d.id = uid(); d.createdAt=Date.now(); db.tags.unshift(d); }
      saveDB(db); closeModal('#modal-tag'); renderTags(); e.target.reset(); e.target.dataset.editId='';
    });

    document.getElementById('form-biz').addEventListener('submit', (e)=>{
      e.preventDefault(); const f = new FormData(e.target); const d = Object.fromEntries(f.entries());
      d.maxProc = +d.maxProc; d.zeroReplica = d.zeroReplica==='true'; d.autoOff = d.autoOff==='true';
      if(e.target.dataset.editId){ const i = db.bizApps.findIndex(x=>x.id===e.target.dataset.editId); d.id=db.bizApps[i].id; d.createdAt=db.bizApps[i].createdAt; d.status=db.bizApps[i].status||'ä¸Šæ¶'; db.bizApps[i]=d; }
      else { d.id = uid(); d.createdAt=Date.now(); d.status='ä¸Šæ¶'; db.bizApps.unshift(d); }
      saveDB(db); closeModal('#modal-biz'); renderBizApps(); e.target.reset(); e.target.dataset.editId='';
    });

    document.getElementById('form-cat').addEventListener('submit', (e)=>{
      e.preventDefault(); const f = new FormData(e.target); const d = Object.fromEntries(f.entries()); d.weight = +d.weight; d.visible = d.visible==='true'; d.apps=(d.apps||'').split(',').map(s=>s.trim()).filter(Boolean); d.updatedAt=Date.now();
      if(e.target.dataset.editId){ const i = db.categories.findIndex(x=>x.id===e.target.dataset.editId); d.id=db.categories[i].id; db.categories[i]=d; }
      else { d.id = uid(); db.categories.push(d); }
      saveDB(db); closeModal('#modal-cat'); renderCategories(); e.target.reset(); e.target.dataset.editId='';
    });

    // --- æ¨¡æ€æ¡†ä¸è¡¨å•å¤ç”¨å·¥å…· ---
    function openModal(sel, _){ document.querySelector(sel).classList.add('show'); }
    function closeModal(sel){ document.querySelector(sel).classList.remove('show'); }
    document.querySelectorAll('[data-close]').forEach(btn=> btn.addEventListener('click', ()=> closeModal(btn.dataset.close)));

    function fillForm(formSel, data){
      const form = document.querySelector(formSel); form.reset(); form.dataset.editId = data && (data.id||'');
      if(!data) return;
      [...form.elements].forEach(el=>{
        if(!el.name) return; const v = data[el.name]; if(v===undefined) return;
        if(el.type==='checkbox') el.checked = !!v; else el.value = Array.isArray(v)? v.join(', ') : v;
      });
    }

    // --- å¯¼å…¥å¯¼å‡º ---
    document.getElementById('exportBtn').onclick = ()=> downloadJSON('mcp-admin-demo.json', db);
    document.getElementById('importBtn').onclick = ()=> {
      const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
      inp.onchange = async ()=>{ const file = inp.files[0]; const text = await file.text(); try{ const data = JSON.parse(text); Object.assign(db, data); saveDB(db); syncRoute(); alert('å¯¼å…¥æˆåŠŸ'); }catch{ alert('JSON è§£æå¤±è´¥'); } };
      inp.click();
    };

    function downloadJSON(filename, data){
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
    }

    // --- å…¨å±€æœç´¢ ---
    document.getElementById('globalSearch').addEventListener('keydown', (e)=>{
      if(e.key!=='Enter') return; const q = e.target.value.trim(); if(!q) return; const hit = db.apps.find(a=>a.name.includes(q)) || db.bizApps.find(b=>b.name.includes(q)); if(hit){ if(hit.corp) goto('biz-apps'); else goto('apps'); } else alert('æœªæ‰¾åˆ°ç›¸å…³å¯¹è±¡');
    });

    // åˆå§‹åŒ–
    syncRoute();
  </script>
</body>
</html>
